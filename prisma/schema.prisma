// This is your Prisma schema file for MOTIVEX E-commerce (Algeria market)
// Database: PostgreSQL
// Features: Bilingual (FR/AR), DZD currency with 2 decimal places, structured shipping

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Pooler connection (port 6543) for runtime
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  RETURNED
}

enum PaymentMethod {
  COD // Cash on Delivery
  BARIDIMOB // BaridiMob payment
}

enum PaymentStatus {
  PENDING
  PAID
}

enum ShippingMethod {
  YALIDINE
  GUEPEX
}

// ============================================
// MODELS
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phone        String?
  role         UserRole @default(USER)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders   Order[]
  payments Payment[]

  @@map("users")
}

model Category {
  id            String  @id @default(cuid())
  nameFr        String  @map("name_fr")
  nameAr        String  @map("name_ar")
  slug          String  @unique
  descriptionFr String? @map("description_fr") @db.Text
  descriptionAr String? @map("description_ar") @db.Text
  isActive      Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  products Product[]

  @@map("categories")
}

model Product {
  id       String   @id @default(cuid())
  sku      String   @unique
  nameFr   String   @map("name_fr")
  nameAr   String   @map("name_ar")
  descFr   String?  @map("desc_fr") @db.Text
  descAr   String?  @map("desc_ar") @db.Text
  price    Decimal  @db.Decimal(12, 2)
  oldPrice Decimal? @map("old_price") @db.Decimal(12, 2)
  stock    Int      @default(0)
  brand    String?
  model    String?
  year     Int?

  // Fitment year range support
  fitmentYearsFrom Int?    @map("fitment_years_from")
  fitmentYearsTo   Int?    @map("fitment_years_to")
  fitmentNotes     String? @map("fitment_notes")

  isActive Boolean @default(true) @map("is_active")

  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  images     ProductImage[]
  orderItems OrderItem[]

  @@index([categoryId])
  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String
  isMain    Boolean @default(false) @map("is_main")
  sortOrder Int     @default(0) @map("sort_order")

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("product_images")
}

model Order {
  id            String      @id @default(cuid())
  paymentCode   String      @unique @map("payment_code")
  status        OrderStatus @default(PENDING)
  subtotal      Decimal     @db.Decimal(12, 2)
  shippingPrice Decimal     @map("shipping_price") @db.Decimal(12, 2)
  total         Decimal     @db.Decimal(12, 2)

  // Structured shipping information
  shippingFullName String         @map("shipping_full_name")
  shippingPhone    String         @map("shipping_phone")
  shippingAddress1 String         @map("shipping_address1")
  shippingWilaya   String         @map("shipping_wilaya")
  shippingCommune  String         @map("shipping_commune")
  shippingNotes    String?        @map("shipping_notes") @db.Text
  shippingMethod   ShippingMethod @default(YALIDINE) @map("shipping_method")

  // Shipping provider tracking
  shippingProvider   String?   @default("YALIDINE") @map("shipping_provider")
  shippingTrackingId String?   @map("shipping_tracking_id")
  shippingStatus     String?   @map("shipping_status")
  shippingLastSync   DateTime? @map("shipping_last_sync")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  items   OrderItem[]
  payment Payment?

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id       String  @id @default(cuid())
  quantity Int
  subtotal Decimal @db.Decimal(12, 2)

  // Bilingual product snapshot at time of order
  snapshotNameFr   String   @map("snapshot_name_fr")
  snapshotNameAr   String   @map("snapshot_name_ar")
  snapshotSku      String   @map("snapshot_sku")
  snapshotPrice    Decimal  @map("snapshot_price") @db.Decimal(12, 2)
  snapshotOldPrice Decimal? @map("snapshot_old_price") @db.Decimal(12, 2)
  snapshotImageUrl String?  @map("snapshot_image_url")
  snapshotBrand    String?  @map("snapshot_brand")
  snapshotModel    String?  @map("snapshot_model")
  snapshotYear     Int?     @map("snapshot_year")

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("order_items")
}

model Payment {
  id              String        @id @default(cuid())
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Decimal       @db.Decimal(12, 2)
  reference       String? // BaridiMob transaction reference
  receiptImageUrl String?       @map("receipt_image_url")

  orderId String @unique @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payments")
}
